@page "/Change-Password"
@using ChatApp.DTO
@attribute [Authorize]
@inject IJwtStorage JwtStorage
@inject IAuthenticationApiProvider AuthenticationApiProvider
@inject AuthenticationStateProvider AuthenticationStateProvider

<h3>Change Password</h3>

<EditForm
    Model="@_changePasswordDto"
    @onclick="() => _isSuccess = false"
    OnValidSubmit="@OnChangePassword">
    <DataAnnotationsValidator/>
    <ValidationSummary/>

    <div class="form-group mt-3">
        <label for="old-password">Old password:</label>
        <InputText type="password" class="form-control" id="old-password" @bind-Value="@_changePasswordDto.OldPassword"/>
    </div>


    <div class="form-group mt-3">
        <label for="new-password">New password:</label>
        <InputText type="password" class="form-control" id="new-password" @bind-Value="@_changePasswordDto.NewPassword"/>
    </div>

    @if (_identityErrors != null)
    {
        <ul class="text-danger mt-5">
            @foreach (var error in _identityErrors)
            {
                <li>
                    @error.Description
                </li>
            }
        </ul>
    }

    <button type="submit" class="btn btn-primary mt-3">Change Password</button>

</EditForm>

@if (_isSuccess)
{
    <h3 class="text-success">
        Password changed successfully.
    </h3>
}


@code {
    private ChangePasswordDto _changePasswordDto = new();
    private List<IdentityError>? _identityErrors;
    private bool _isSuccess;

    private async Task OnChangePassword()
    {
        var response = await AuthenticationApiProvider.ChangePassword(_changePasswordDto);
        if (response.IsSuccessStatusCode)
        {
            var token = await response.Content.ReadAsStringAsync();
            await JwtStorage.SaveJwtTokenAsync(token);
            await AuthenticationStateProvider.GetAuthenticationStateAsync();
            _changePasswordDto = new();
            _identityErrors = null;
            _isSuccess = true;
        }
        if (response.StatusCode == HttpStatusCode.BadRequest)
        {
            _identityErrors = await response.Content.ReadFromJsonAsync<List<IdentityError>>();
        }
    }

}